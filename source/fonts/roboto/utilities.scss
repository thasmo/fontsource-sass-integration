@use 'sass:list';
@use 'sass:map';
@use 'sass:math';
@use 'sass:string';
@use 'sass:meta';

@use 'metadata';

$metadata: meta.module-variables(metadata) !default;
$name: map.get($metadata, name) !default;
$styles: map.get($metadata, defaults, style) !default;
$weights: map.get($metadata, defaults, weight) !default;
$widths: map.get($metadata, defaults, width) !default;
$subsets: all !default;
$axes: null !default;
$suffix: null !default;

@function face-style(
	$value,
	$axis: null,
	$axes: map.get($metadata, axes),
) {
	@if ($axis == all or $axis == slnt) and map.has-key($axes, slnt) {
		@return oblique map.get($axes, slnt, min) + deg map.get($axes, slnt, max) + deg;
	} @else if meta.type-of($axis) == map {
		@return oblique map.get($axis, min) + deg map.get($axis, max) + deg;
	} @else if $value {
		@return $value;
	}

	@return null;
}

@function face-weight(
	$value,
	$axis: null,
	$axes: map.get($metadata, axes),
) {
	@if ($axis == all or $axis == wght) and map.has-key($axes, wght) {
		@return map.get($axes, wght, min) map.get($axes, wght, max);
	} @else if meta.type-of($axis) == map {
		@return map.get($axis, min) map.get($axis, max);
	} @else if $value {
		@return $value;
	}

	@return null;
}

@function face-width(
	$value,
	$axis: null,
	$axes: map.get($metadata, axes),
) {
	@if ($axis == all or $axis == wdth) and map.has-key($axes, wdth) {
		@return math.percentage(math.div(map.get($axes, wdth, min), 100)) math.percentage(math.div(map.get($axes, wdth, max), 100));
	} @else if meta.type-of($axis) == map {
		@return math.percentage(math.div(map.get($axis, min), 100)) math.percentage(math.div(map.get($axis, wdth, max), 100));
	} @else if $value {
		@return $value;
	}

	@return null;
}

@function face-variation(
	$axis,
	$axes: map.get($metadata, axes),
) {
	@if ($axis == all or $axis == ital) and map.has-key($axes, ital) {
		@return 'ital' 1;
	} @else if meta.type-of($axis) == map {
		@return 'ital' map.get($axis, max);
	}

	@return null;
}

@function glyphs(
	$subset,
	$subsets: map.get($metadata, subsets),
) {
	@if meta.type-of($subset) == map {
		@return $subset;
	} @else if map.has-key($subsets, $subset) {
		@return map.get($subsets, $subset);
	}

	@return null;
}

@function source(
	$axis: null,
	$subset: map.get($metadata, defaults, subset),
	$style: map.get($metadata, defaults, style),
	$weight: map.get($metadata, defaults, weight),
	$axes: map.get($metadata, axes),
) {
	@if (($axis == all and list.length(map.keys($axes)) > 0) or map.has-key($axes, $axis)) {
		@return
			url('#{path($axis: $axis, $style: $style, $subset: $subset, $format: woff2)}') format('woff2 supports variations'),
			url('#{path($axis: $axis, $style: $style, $subset: $subset, $format: woff2)}') format('woff2-variations');
	} @else {
		@return
			url('#{path($weight: $weight, $style: $style, $subset: $subset, $format: woff2)}') format('woff2'),
			url('#{path($weight: $weight, $style: $style, $subset: $subset, $format: woff)}') format('woff');
	}
}

@function path(
	$axis: null,
	$format: woff2,
	$weight: map.get($metadata, defaults, weight),
	$style: map.get($metadata, defaults, style),
	$subset: map.get($metadata, defaults, subset),
	$identifier: map.get($metadata, identifier),
	$base: map.get($metadata, directory),
) {
	@if $axis {
		@return '#{$base}/#{$identifier}-#{$subset}-variable-#{if($axis == all, 'full', $axis + 'Only')}-#{$style}.woff2';
	} @else {
		@return '#{$base}/#{$identifier}-#{$subset}-#{$weight}-#{$style}.#{$format}';
	}
}

@mixin faces(
	$name: $name,
	$styles: $styles,
	$weights: $weights,
	$widths: $widths,
	$subsets: $subsets,
	$axes: $axes,
	$suffix: $suffix,
	$metadata: $metadata,
) {
	@each $axis, $metrics in $axes {
		@each $style in if($axis, map.get($metadata, defaults, style), if($styles == all, map.get($metadata, styles), $styles)) {
			@each $weight in if($axis, map.get($metadata, defaults, weight), if($weights == all, map.get($metadata, weights), $weights)) {
				@each $width in if($axis, map.get($metadata, defaults, width), if($widths == all, map.get($metadata, widths), $widths)) {
					@each $subset, $glyphs in if($subsets == all, map.keys(map.get($metadata, subsets)), $subsets) {
						@each $glyphs in glyphs(if($glyphs, $glyphs, $subset)) {
							$data: (
								arguments: (
									name: $name,
									styles: $styles,
									weights: $weights,
									widths: $widths,
									subsets: $subsets,
									axes: $axes,
									suffix: $suffix,
									metadata: $metadata,
								),
								values: (
									axis: $axis,
									metrics: $metrics,
									style: $style,
									weight: $weight,
									width: $width,
									subset: $subset,
									glyphs: $glyphs,
								),
								properties: (
									font-family: string.quote(#{$name if($axis, $suffix, null)}),
									font-style: face-style($style, if($axis == slnt and $metrics, $metrics, $axis)),
									font-weight: face-weight($weight, if($axis == slnt and $metrics, $metrics, $axis)),
									font-stretch: face-width($width, if($axis == wdth and $metrics, $metrics, $axis)),
									font-variation-settings: face-variation(if($axis == ital and $metrics, $metrics, $axis)),
									unicode-range: $glyphs,
									src: source($axis, $subset, $style, $weight),
								)
							);

							/* #{$name, $style, $weight, $width} (Subset: #{$subset}, Axis: #{$axis}) */
							@font-face {
								font-family: map.get($data, properties, font-family);
								font-style: map.get($data, properties, font-style);
								font-weight: map.get($data, properties, font-weight);
								font-stretch: map.get($data, properties, font-stretch);
								font-variation-settings: map.get($data, properties, font-variation-settings);

								@content($data);

								unicode-range: map.get($data, properties, unicode-range);

								src: map.get($data, properties, src);
							}
						}
					}
				}
			}
		}
	}
}
